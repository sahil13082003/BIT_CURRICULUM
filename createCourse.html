<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="javascript.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Text Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <link rel="stylesheet" href="ChatBot.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <script src="ChatBot.js" defer></script>
</head>

<body>
    <button class="chatbot-toggler">
        <span >
          <img src="195.png" style="display: flex; height: 100px; width: 100px;">
        </span>
        <span class="material-symbols-outlined">close</span>
      </button>
      <div class="chatbot">
        <header>
          <h2>Chatbot</h2>
          <span class="close-btn material-symbols-outlined">close</span>
        </header>
        <ul class="chatbox">
          <li class="chat incoming">
            <span class="material-symbols-outlined">smart_toy</span>
            <p>Hi, Welcome to Aicte Curriculum Portal ðŸ‘‹<br>How can I help you?</p>
          </li>
        </ul>
        <div class="chat-input">
          <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
          <span id="send-btn" class="material-symbols-rounded">send</span>
        </div>
      </div>
  
    <nav class="navbar navbar-expand-lg"
        style="background-image: linear-gradient(to right,white,#2196f3);color: white;">
        <div class="container-fluid">
            <img src="logo.png" width="100px" height="auto">
        </div>
    </nav>
    <div style="right: 10%;" >
        <a href="developerDashboard.html"><img src="left.png" width="50px" height="auto"></a>
        </div>
    <div class="container">

        <a href="digitalLibrary.html">
            <button class="btn btn-primary">Digital library</button>
          </a>
              <h1 class="mt-5 mb-5" style="text-align: center;color: #2196f3;">
        You may now start your designing here...
    </h1>
    <div class="alert" role="alert" style="display: flex;">
        <img src="saving.gif" width="50" style="padding: 10px;">
        <span style="padding-left: 20px;display: none;" class="text-danger" id="saving">
            <b>Auto Saving...</b>
        </span>
        <a href="chat.html" target="_self" style="display: flex; justify-content: center;">
            <div >
                <img src="chatlogo.jpg" width="80" style="display:flex; text-align:center;">
            </div>
        </a>
    </div>
        <div class="form-group border border-primary border-3 rounded-3">
            <textarea id="courseDescription" name="courseDescription" rows="8"></textarea>
        </div>
        <button type="button" class="btn btn-outline-primary mt-5 mb-5" style="display: block; margin:0 auto "
            id="save">Save</button>
        <div class="spinner-border text-info mb-5 mt-5" role="status" style="display: none;margin: 0 auto;"
            id="loader02">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="modal fade" id="modal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body border border-primary border-2 rounded-2 m-5" style="display: none;"
                    id="fetchCourse">
                    <!--Course Will fetch here-->
                </div>
                <div class="modal-body border border-primary border-2 rounded-2 m-5" id="placeholder1">
                    <p class="placeholder-glow">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>

                    <p class="placeholder-wave">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>
                    <p class="placeholder-glow">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>

                    <p class="placeholder-wave">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>
                    <p class="placeholder-glow">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>

                    <p class="placeholder-wave">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>
                    <p class="placeholder-glow">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>

                    <p class="placeholder-wave">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>
                    <p class="placeholder-glow">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>

                    <p class="placeholder-wave">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>
                    <p class="placeholder-glow">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>

                    <p class="placeholder-wave">
                        <span class="placeholder col-12 bg-primary"></span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="sendForApproval">Send for Further Process</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCskC8FgXJxC48XzpCDRVmE9Kng2OyAbpk",
            authDomain: "open-curriculum-de09c.firebaseapp.com",
            projectId: "open-curriculum-de09c",
            storageBucket: "open-curriculum-de09c.appspot.com",
            messagingSenderId: "425347625827",
            appId: "1:425347625827:web:5603db72da26bfe87ad956",
            measurementId: "G-S9YVNWDKBT"
        };
        var app = initializeApp(firebaseConfig);
        var db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            tinymce.init({
                selector: '#courseDescription',
                height: 400,
                plugins: [
                    'advlist', 'autolink', 'link', 'image', 'lists', 'charmap', 'preview', 'anchor', 'pagebreak',
                    'searchreplace', 'wordcount', 'visualblocks', 'code', 'fullscreen', 'insertdatetime', 'media',
                    'table', 'emoticons', 'template', 'help', 'print'
                ], toolbar: 'undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons', menu: {
                    favs: { title: 'My Favorites', items: 'code visualaid | searchreplace | emoticons' }
                },
                toolbar: 'undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | ' +
                    'bullist numlist outdent indent | link image | print preview media fullscreen | ' +
                    'forecolor backcolor emoticons | help',
                menu: {
                    favs: { title: 'My Favorites', items: 'code visualaid | searchreplace | emoticons' }
                },
                menubar: 'favs file edit view insert format tools table help',
                content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }',

                setup: function (editor) {
                    editor.on('init', function () {
                        /*              let savedData = localStorage.getItem('formData');
                                      console.log(savedData)
                                      if (!savedData || savedData === "null" || savedData === "undefined") {
                                          console.log("No data found in localStorage");
                                      } else {
                                          try {
                                              const parsedData = JSON.parse(savedData);
                                              if (parsedData && parsedData.description) {
                                                  editor.setContent(parsedData.description);
                                              } else {
                                                  console.log("Description not found in parsed data");
                                              }
                                          } catch (error) {
                                              console.error("Error parsing JSON:", error);
                                          }
                                      }
              */

                        if (sessionStorage.getItem('inviter') !== null && sessionStorage.getItem('inviter') !== "null") {
                            console.log("You are invited hence data fetch and saved in inviter dataId")
                            getContent()
                            // 'inviter' exists and is not null
                            // Do something
                        } else {
                            getdataFromInviterDB();
                            console.log("Your are not invited, hence data is fetch from you dataId")
                            // 'inviter' does not exist or is null
                            // Do something else
                        }

                        async function getdataFromInviterDB() {
                            var dataRef = await getDoc(doc(db, "Teachers", localStorage.getItem("dataId"), sessionStorage.getItem("tempCardId"), "Course"));
                            const data = dataRef.data();
                            console.log(data)
                            editor.setContent(data.description);
                        }

                        async function getContent() {
                            const coursName = sessionStorage.getItem('CoursName');
                            const inviter = sessionStorage.getItem('inviter');
                            if (coursName && inviter) {
                                try {
                                    const dataSnap = await getDoc(doc(db, "Teachers", sessionStorage.getItem('inviter'), sessionStorage.getItem('CoursName'), "Course"))
                                    if (dataSnap.exists()) {
                                        const data = dataSnap.data();
                                        console.log(data)
                                        editor.setContent(data.description);
                                    } else {
                                        console.log("No Document found")
                                    }
                                } catch (error) {
                                    console.log(error)
                                }
                            }
                        }
                        // Function to save form data to localStorage
                        setInterval(() => {
                            document.getElementById("saving").style.display = "none";
                            const courseDescription = editor.getContent();
                            const formData = {
                                description: courseDescription,
                            };
                            localStorage.setItem('formData', JSON.stringify(formData));
                        }, 2000);

                        //   flashText()
                        function flashText() {
                            var currentData = localStorage.getItem("formData");
                            setInterval(() => {
                                if (currentData === localStorage.getItem("formData")) {
                                    document.getElementById("saving").style.display = "none"
                                } else {
                                    currentData = localStorage.getItem("formData");
                                    document.getElementById("saving").style.display = "inline-block"
                                }
                            }, 6000)
                        }

                        document.getElementById("save").addEventListener("click", async (event) => {
                            event.preventDefault();
                            document.getElementById("loader02").style.display = "block"
                            const name = localStorage.getItem("CourseName");
                            const courseDescription = editor.getContent();
                            const courseData = {
                                description: courseDescription,
                            };
                            const data = {
                                [name]: localStorage.getItem("CourseName")
                            }
                            const coursName = sessionStorage.getItem('CoursName');
                            const inviter = sessionStorage.getItem('inviter');
                            let dataID = sessionStorage.getItem('tempCardId') === null ? localStorage.getItem("CourseName") : sessionStorage.getItem("tempCardId");
                            console.log(dataID)

                            if (sessionStorage.getItem('inviter') !== null && sessionStorage.getItem('inviter') !== "null") {
                                try {
                                    await setDoc(doc(db, "Teachers", inviter, coursName, "Course"), courseData, { merge: true });
                                    console.log("Saved successfully");
                                    localStorage.removeItem('formData');
                                    document.getElementById("loader02").style.display = "none"
                                    alert("Course saved in inviter dataId");
                                } catch (error) {
                                    document.getElementById("loader02").style.display = "none"
                                    console.error('Error adding document: ', error);
                                }
                            } else {
                                try {
                                    await setDoc(doc(db, "Teachers", localStorage.getItem("dataId"), dataID, "Course"), courseData, { merge: true });
                                    await setDoc(doc(db, "Teachers", localStorage.getItem("dataId")), data, { merge: true })
                                    console.log("Saved successfully");
                                    localStorage.removeItem('formData');
                                    document.getElementById("loader02").style.display = "none"
                                    alert("Course saved successfully")
                                    fetchCourse(db)
                                } catch (error) {
                                    document.getElementById("loader02").style.display = "none"
                                    console.error('Error adding document: ', error);
                                }
                            }

                        });

                    });
                }
            });
        });

        document.getElementById("sendForApproval").addEventListener("click", () => {
            window.location.replace("sendForApproval.html")
        })

        async function fetchCourse(db) {
            $(document).ready(function () {
                $('#modal1').modal('show');
            })
            try {
                let dataID = sessionStorage.getItem('tempCardId') === null ? localStorage.getItem("CourseName") : sessionStorage.getItem("tempCardId");
                const dataSnap = await getDoc(doc(db, "Teachers", localStorage.getItem("dataId"), dataID, "Course"))
                if (dataSnap.exists()) {
                    const data = dataSnap.data();
                    document.getElementById("placeholder1").style.display = "none";
                    document.getElementById("fetchCourse").style.display = "block";
                    document.getElementById("fetchCourse").innerHTML = `
                    <div class="container">
                        <div class="container border rounded-2 p-3 mt-3">
                            <h3>Course Content</h3>${data.description}
                        </div>
                    </div>`
                } else {
                    console.log("No Document found")
                }
            } catch (error) {
                console.log(error)
            }
        }
    </script>
</body>

</html>